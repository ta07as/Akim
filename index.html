<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talas_master CRM — AI Ad & Creative Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --brand-black: #000000;
            --brand-gold: #FBBF24;
            --brand-white: #FFFFFF;
        }
        body {
            background-color: #050505;
            color: var(--brand-white);
            font-family: 'Inter', sans-serif;
        }
        .gold-border { border-color: var(--brand-gold); }
        .gold-text { color: var(--brand-gold); }
        .gold-bg { background-color: var(--brand-gold); }
        .card { background-color: #0f0f0f; border: 1px solid #1a1a1a; transition: all 0.2s; }
        .card:hover { border-color: #333; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--brand-gold); }

        input, select, textarea {
            background-color: #000 !important;
            border: 1px solid #222 !important;
            color: white !important;
        }
        input:focus { border-color: var(--brand-gold) !important; outline: none; box-shadow: 0 0 0 1px var(--brand-gold); }

        .btn-nav { @apply flex items-center gap-3 w-full px-4 py-3 rounded-lg transition-all; }
        .btn-nav:hover { background-color: #1a1a1a; }
        .active-nav { background-color: #FBBF24 !important; color: #000 !important; font-weight: bold; }

        #ai-chat-window { box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; }
        .ai-message { background: #1a1a1a; border-radius: 12px 12px 12px 0; }
        .user-message { background: var(--brand-gold); color: black; border-radius: 12px 12px 0 12px; }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .video-preview {
            background: black;
            aspect-ratio: 9/16;
            max-width: 300px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border: 4px solid #1a1a1a;
            border-radius: 20px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row">

    <!-- Mobile Header -->
    <div class="md:hidden bg-black p-4 border-b border-zinc-800 flex justify-between items-center">
        <div class="font-bold uppercase tracking-tighter">TALAS<span class="gold-text">_MASTER</span> AI</div>
        <button onclick="toggleSidebar()" class="gold-text text-2xl"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-black border-r border-zinc-800 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-8 border-b border-zinc-900 hidden md:block">
            <div class="text-2xl font-black tracking-tighter uppercase leading-none">
                TALAS<br><span class="gold-text">_MASTER</span> AI
            </div>
            <p class="text-[10px] text-zinc-500 mt-2 tracking-widest uppercase font-bold">Ad & CRM Suite</p>
        </div>

        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <button onclick="showSection('dashboard')" id="nav-dashboard" class="btn-nav active-nav">
                <i class="fas fa-th-large"></i> Дашборд
            </button>
            <button onclick="showSection('ai-tools')" id="nav-ai-tools" class="btn-nav">
                <i class="fas fa-video"></i> Студия Рекламы AI
            </button>
            <button onclick="showSection('database')" id="nav-database" class="btn-nav">
                <i class="fas fa-database"></i> База заказов
            </button>
            <button onclick="showSection('add')" id="nav-add" class="btn-nav">
                <i class="fas fa-plus-square"></i> Новый заказ
            </button>
            <div class="pt-10 px-4 text-[10px] text-zinc-600 uppercase font-bold tracking-widest">Сервис</div>
            <button onclick="exportData()" class="btn-nav text-zinc-400">
                <i class="fas fa-file-export"></i> Экспорт
            </button>
            <button onclick="speakSummary()" class="btn-nav text-zinc-400">
                <i class="fas fa-volume-up"></i> Озвучить отчет
            </button>
        </nav>

        <div class="p-4 border-t border-zinc-900 text-center">
            <p class="text-[10px] text-zinc-500">Talas, Kyrgyzstan</p>
            <p class="text-[10px] text-zinc-700 font-mono">+996 755 000 228</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 relative">
        <header class="h-16 bg-black/50 backdrop-blur-md border-b border-zinc-900 flex items-center px-4 md:px-8 justify-between sticky top-0 z-40">
            <div class="relative w-full max-w-md">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 gold-text"></i>
                <input type="text" id="globalSearch" oninput="searchOrders()" placeholder="Поиск клиента..." class="w-full pl-10 pr-4 py-2 rounded-full text-sm">
            </div>
            <button onclick="toggleAIChat()" class="w-10 h-10 rounded-full gold-bg text-black flex items-center justify-center shadow-lg transition transform hover:scale-110">
                <i class="fas fa-robot text-lg"></i>
            </button>
        </header>

        <div class="p-4 md:p-8 overflow-y-auto" id="main-area">
            
            <!-- SECTION: DASHBOARD -->
            <div id="section-dashboard" class="space-y-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <h2 class="text-3xl font-black uppercase italic">Главная панель</h2>
                    <div class="flex gap-2">
                        <span class="px-3 py-1 bg-zinc-900 rounded-full text-[10px] font-bold border border-zinc-800">LIVE DATA</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="card p-6 rounded-2xl border-l-4 border-yellow-500">
                        <p class="text-[10px] text-zinc-500 uppercase font-bold">Выручка</p>
                        <h3 class="text-3xl font-black mt-2 tracking-tighter" id="dash-revenue">0 сом</h3>
                    </div>
                    <div class="card p-6 rounded-2xl border-l-4 border-red-500">
                        <p class="text-[10px] text-zinc-500 uppercase font-bold">Ожидают</p>
                        <h3 class="text-3xl font-black mt-2 text-red-500" id="dash-pending">0</h3>
                    </div>
                    <div class="card p-6 rounded-2xl border-l-4 border-blue-500">
                        <p class="text-[10px] text-zinc-500 uppercase font-bold">В процессе</p>
                        <h3 class="text-3xl font-black mt-2 text-blue-500" id="dash-progress">0</h3>
                    </div>
                    <div class="card p-6 rounded-2xl border-l-4 border-green-500">
                        <p class="text-[10px] text-zinc-500 uppercase font-bold">Выполнено</p>
                        <h3 class="text-3xl font-black mt-2 text-green-500" id="dash-done">0</h3>
                    </div>
                </div>
            </div>

            <!-- SECTION: AI TOOLS (EXPANDED AD STUDIO) -->
            <div id="section-ai-tools" class="hidden space-y-8">
                <div class="flex items-end gap-4 mb-4">
                    <h2 class="text-4xl font-black gold-text uppercase leading-none">AI AD STUDIO</h2>
                    <span class="text-[10px] bg-zinc-900 px-3 py-1 rounded-full text-zinc-400 font-bold mb-1">PRO CREATIVE</span>
                </div>
                <p class="text-zinc-500 text-sm max-w-2xl">Создавайте профессиональный контент для продвижения услуг Talas_master: видео-рилсы, рекламные баннеры и сметы за секунды.</p>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- VIDEO GENERATOR -->
                    <div class="card p-8 rounded-3xl flex flex-col border-t-4 border-red-600 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-30 transition"><i class="fas fa-video text-6xl"></i></div>
                        <h4 class="text-xl font-black mb-2 uppercase">AI Видео-Промо</h4>
                        <p class="text-xs text-zinc-500 mb-6">Генерация сценария и визуальных эффектов для Instagram Reels / WhatsApp Status.</p>
                        
                        <label class="text-[10px] uppercase font-bold text-zinc-600 mb-2">Выберите тип услуги</label>
                        <select id="ai-video-type" class="w-full p-4 rounded-xl mb-4 text-sm font-bold">
                            <option value="Электрика">Электрика (Монтаж, щитки)</option>
                            <option value="Сантехника">Сантехника (Трубы, краны)</option>
                            <option value="Клининг">Клининг (Уборка, химчистка)</option>
                            <option value="Стройка">Стройка (Кирпич, стены)</option>
                        </select>

                        <button onclick="generateVideoAd()" id="btn-video" class="mt-auto w-full bg-red-600 text-white font-black py-4 rounded-xl text-xs uppercase tracking-widest hover:bg-red-500 transition shadow-lg">Создать Видео-Промо</button>
                    </div>

                    <!-- AD POSTER GENERATOR -->
                    <div class="card p-8 rounded-3xl flex flex-col border-t-4 border-blue-600 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-30 transition"><i class="fas fa-image text-6xl"></i></div>
                        <h4 class="text-xl font-black mb-2 uppercase">AI Рекламный Постер</h4>
                        <p class="text-xs text-zinc-500 mb-6">Создание фото с наложением текста и логотипа для привлечения клиентов.</p>
                        
                        <label class="text-[10px] uppercase font-bold text-zinc-600 mb-2">Акцент рекламы</label>
                        <select id="ai-poster-style" class="w-full p-4 rounded-xl mb-4 text-sm font-bold">
                            <option value="modern clean">Современный / Чистый</option>
                            <option value="brutal industrial">Брутальный / Рабочий</option>
                            <option value="before after">До / После</option>
                        </select>

                        <input type="text" id="ai-poster-prompt" placeholder="Напр: Срочный вызов электрика..." class="w-full p-4 rounded-xl mb-4 text-sm">

                        <button onclick="generatePosterAd()" id="btn-poster" class="mt-auto w-full bg-blue-600 text-white font-black py-4 rounded-xl text-xs uppercase tracking-widest hover:bg-blue-500 transition shadow-lg">Генерировать Баннер</button>
                    </div>

                    <!-- ESTIMATE AI -->
                    <div class="card p-8 rounded-3xl flex flex-col border-t-4 border-yellow-500 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-30 transition"><i class="fas fa-file-invoice-dollar text-6xl"></i></div>
                        <h4 class="text-xl font-black mb-2 uppercase">AI Смета & КП</h4>
                        <p class="text-xs text-zinc-500 mb-6">Быстрый расчет стоимости работ для отправки клиенту в PDF или текстом.</p>
                        
                        <textarea id="ai-est-input" placeholder="Опишите объем работ..." class="w-full p-4 rounded-xl h-28 mb-4 text-sm"></textarea>

                        <button onclick="generateEstimate()" id="btn-est" class="mt-auto w-full gold-bg text-black font-black py-4 rounded-xl text-xs uppercase tracking-widest hover:brightness-110 transition shadow-lg">Рассчитать стоимость</button>
                    </div>
                </div>

                <!-- AI STUDIO OUTPUT -->
                <div id="ai-studio-output" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div class="card p-1 rounded-[40px] border border-zinc-800 bg-zinc-950 overflow-hidden">
                        <div class="p-8 border-b border-zinc-900 flex justify-between items-center">
                            <div>
                                <h5 class="font-black text-lg uppercase" id="studio-title">Предпросмотр контента</h5>
                                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Talas_master Creative Output</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="closeStudio()" class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center hover:bg-zinc-800"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div id="studio-content" class="p-8 flex flex-col md:flex-row gap-8 items-center justify-center min-h-[400px]">
                            <!-- Content injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: DATABASE -->
            <div id="section-database" class="hidden space-y-6">
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h3 class="text-2xl font-black uppercase">Реестр заказов</h3>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Управление базой данных</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <select id="filter-date" onchange="renderDatabase()" class="p-2 rounded-lg text-[10px] font-bold uppercase border-zinc-800 bg-zinc-900">
                            <option value="all">Все время</option>
                            <option value="today">Сегодня</option>
                            <option value="week">Эта неделя</option>
                            <option value="month">Этот месяц</option>
                        </select>
                        <select id="sort-order" onchange="renderDatabase()" class="p-2 rounded-lg text-[10px] font-bold uppercase border-zinc-800 bg-zinc-900">
                            <option value="desc">Сначала новые</option>
                            <option value="asc">Сначала старые</option>
                        </select>
                    </div>
                 </div>

                 <div class="card rounded-3xl overflow-hidden border border-zinc-900 shadow-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-zinc-900/50 text-[10px] uppercase text-zinc-500 font-bold tracking-widest border-b border-zinc-800">
                                <tr>
                                    <th class="p-6">ID / Дата</th>
                                    <th class="p-6">Клиент</th>
                                    <th class="p-6">Услуга</th>
                                    <th class="p-6">Бюджет</th>
                                    <th class="p-6">Статус</th>
                                    <th class="p-6 text-right">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="db-table-body" class="text-xs divide-y divide-zinc-900/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: ADD -->
            <div id="section-add" class="hidden max-w-xl mx-auto pt-10">
                <div class="card p-10 rounded-[40px] border-t-8 gold-border shadow-2xl relative">
                    <div class="absolute -top-6 left-10 gold-bg text-black px-6 py-2 rounded-full shadow-lg font-black text-xs uppercase italic">New Entry</div>
                    <h3 class="text-2xl font-black uppercase mb-8 mt-2">Регистрация заказа</h3>
                    <form id="orderForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] uppercase font-bold text-zinc-600 block mb-2">Клиент</label>
                                <input type="text" id="form-name" required placeholder="ФИО" class="w-full p-4 rounded-xl border border-zinc-800 bg-black">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-zinc-600 block mb-2">Телефон</label>
                                <input type="tel" id="form-phone" value="+996 " required class="w-full p-4 rounded-xl border border-zinc-800 bg-black">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-zinc-600 block mb-2">Категория</label>
                            <select id="form-type" class="w-full p-4 rounded-xl border border-zinc-800 bg-black">
                                <option>Электрика</option>
                                <option>Сантехника</option>
                                <option>Клининг</option>
                                <option>Кладка кирпича</option>
                                <option>Поклейка обоев</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-zinc-600 block mb-2">Стоимость (сом)</label>
                            <input type="number" id="form-price" placeholder="0" class="w-full p-4 rounded-xl border border-zinc-800 bg-black">
                        </div>
                        <button type="submit" class="w-full gold-bg text-black font-black py-5 rounded-2xl uppercase text-xs tracking-widest hover:scale-[1.02] transition transform shadow-xl">Внести в базу</button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- AI CHAT WINDOW -->
    <div id="ai-chat-window" class="fixed bottom-20 right-4 md:right-8 w-[400px] max-w-[95vw] h-[600px] bg-black border border-zinc-800 rounded-[40px] z-[100] flex flex-col overflow-hidden shadow-2xl">
        <div class="p-6 border-b border-zinc-800 flex items-center justify-between bg-zinc-900/30 backdrop-blur-xl">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 gold-bg rounded-2xl flex items-center justify-center text-black shadow-lg rotate-3">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <span class="block font-black text-xs uppercase tracking-tighter">Talas AI Studio</span>
                    <span class="block text-[8px] text-zinc-500 uppercase font-bold">Enterprise Assistant</span>
                </div>
            </div>
            <button onclick="toggleAIChat()" class="text-zinc-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 text-[11px]">
            <div class="ai-message p-4">Привет! Я помогу тебе управлять базой и создавать контент для рекламы. Что сегодня сделаем?</div>
        </div>
        <div class="p-6 bg-zinc-950 border-t border-zinc-900 flex gap-2">
            <input type="text" id="ai-input" onkeypress="if(event.key==='Enter')handleAISend()" placeholder="Ваш запрос..." class="flex-1 p-4 rounded-2xl text-xs bg-black border-none focus:ring-1 focus:ring-yellow-500 outline-none">
            <button onclick="handleAISend()" class="gold-bg text-black w-12 rounded-2xl flex items-center justify-center hover:brightness-110"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div id="notify" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-zinc-900 text-white px-8 py-4 rounded-full font-bold shadow-2xl translate-y-20 opacity-0 transition-all z-[101] flex items-center gap-4 border border-zinc-800">
        <div id="notify-icon" class="gold-text"><i class="fas fa-bolt"></i></div>
        <span id="notify-text" class="text-[10px] uppercase tracking-widest font-black"></span>
    </div>

    <script>
        const apiKey = ""; 
        let db = JSON.parse(localStorage.getItem('talas_master_v6')) || [];

        window.onload = () => {
            persist();
        };

        function persist() {
            localStorage.setItem('talas_master_v6', JSON.stringify(db));
            updateStats();
            renderDatabase();
        }

        function updateStats() {
            const rev = db.filter(o => o.status === 'done').reduce((acc, curr) => acc + (Number(curr.price) || 0), 0);
            document.getElementById('dash-revenue').innerText = rev.toLocaleString() + ' сом';
            document.getElementById('dash-pending').innerText = db.filter(o => o.status === 'pending').length;
            document.getElementById('dash-progress').innerText = db.filter(o => o.status === 'progress').length;
            document.getElementById('dash-done').innerText = db.filter(o => o.status === 'done').length;
        }

        function showSection(id) {
            ['dashboard', 'database', 'add', 'ai-tools'].forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                document.getElementById(`nav-${s}`).classList.remove('active-nav');
            });
            document.getElementById(`section-${id}`).classList.remove('hidden');
            document.getElementById(`nav-${id}`).classList.add('active-nav');
            if (window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        function toggleAIChat() { const c = document.getElementById('ai-chat-window'); c.style.display = c.style.display === 'flex' ? 'none' : 'flex'; }

        // --- AI AD STUDIO LOGIC ---

        async function generateVideoAd() {
            const type = document.getElementById('ai-video-type').value;
            setAILoader('btn-video', true);
            
            const prompt = `Создай детальный сценарий для 15-секундного рекламного ролика (Reels) для услуги "${type}" компании Talas_master (город Талас). Включи: 1. Визуальный ряд, 2. Текст на экране, 3. Звуковое сопровождение. Добавь призыв к действию с номером +996 755 000 228.`;
            
            try {
                const text = await callGemini(prompt);
                const html = `
                    <div class="video-preview flex flex-col items-center justify-center p-6 text-center">
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/80 z-0"></div>
                        <div class="z-10 animate-pulse mb-4"><i class="fas fa-play-circle text-6xl gold-text"></i></div>
                        <div class="z-10 text-[10px] uppercase font-bold gold-text mb-2">TALAS_MASTER PROMO</div>
                        <div class="z-10 text-xs font-black uppercase mb-10">${type}</div>
                        <div class="z-10 text-[8px] opacity-70 mb-4 tracking-tighter leading-tight">Тут будет ваш видеоряд на основе сценария</div>
                        <div class="z-10 text-[10px] font-mono">+996 755 000 228</div>
                    </div>
                    <div class="flex-1 max-w-md text-sm space-y-4">
                        <div class="text-xs gold-text font-black uppercase tracking-widest">Сценарий от ИИ:</div>
                        <div class="bg-zinc-900 p-4 rounded-2xl italic border border-zinc-800 text-[11px] leading-relaxed">${text}</div>
                        <button class="w-full bg-zinc-800 py-3 rounded-xl text-[10px] font-bold uppercase hover:bg-zinc-700 transition">Скачать сценарий</button>
                    </div>
                `;
                showStudioContent("Видео-Промо Сценарий", html);
            } catch(e) { notify('Ошибка генерации видео'); }
            setAILoader('btn-video', false);
        }

        async function generatePosterAd() {
            const style = document.getElementById('ai-poster-style').value;
            const promptText = document.getElementById('ai-poster-prompt').value;
            if(!promptText) return notify('Введите текст рекламы');

            setAILoader('btn-poster', true);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        instances: { prompt: `Industrial advertising poster for company "Talas_master". Service: ${promptText}. Aesthetic: ${style}, professional photography, high contrast, black and yellow color palette, 4k resolution.` }, 
                        parameters: { sampleCount: 1 } 
                    })
                });
                const result = await response.json();
                const b64 = result.predictions[0].bytesBase64Encoded;
                const html = `
                    <div class="flex flex-col items-center gap-6">
                        <img src="data:image/png;base64,${b64}" class="w-[300px] h-[533px] object-cover rounded-3xl shadow-2xl border-4 border-zinc-900">
                        <div class="flex gap-2">
                             <button class="bg-zinc-900 px-6 py-3 rounded-xl text-[10px] font-bold uppercase border border-zinc-800">Сохранить</button>
                             <button class="gold-bg text-black px-6 py-3 rounded-xl text-[10px] font-bold uppercase">В WhatsApp</button>
                        </div>
                    </div>
                `;
                showStudioContent("Рекламный Баннер", html);
            } catch(e) { notify('Ошибка Imagen 4.0'); }
            setAILoader('btn-poster', false);
        }

        async function generateEstimate() {
            const input = document.getElementById('ai-est-input').value;
            if(!input) return notify('Опишите работы');
            setAILoader('btn-est', true);
            
            const prompt = `Ты профессиональный прораб Talas_master. Составь подробное коммерческое предложение (КП) для клиента по запросу: "${input}". Раздели на "Материалы" и "Работы". Используй валюту "сом". В конце добавь контакты: +996 755 000 228.`;
            const text = await callGemini(prompt);
            const html = `
                <div class="w-full max-w-2xl bg-white text-black p-10 rounded-xl shadow-inner font-serif">
                    <div class="flex justify-between border-b-2 border-black pb-4 mb-6">
                        <div class="font-black text-xl uppercase tracking-tighter">TALAS_MASTER</div>
                        <div class="text-[10px] font-mono text-right">№ ${Math.floor(Math.random()*10000)}<br>${new Date().toLocaleDateString()}</div>
                    </div>
                    <div class="whitespace-pre-line text-[12px] leading-loose">${text}</div>
                </div>
            `;
            showStudioContent("Смета / Предложение", html);
            setAILoader('btn-est', false);
        }

        // --- DATABASE LOGIC ---

        function renderDatabase() {
            const body = document.getElementById('db-table-body');
            const dateFilter = document.getElementById('filter-date').value;
            const sortOrder = document.getElementById('sort-order').value;

            let filtered = [...db];

            // Filter
            if (dateFilter !== 'all') {
                const now = new Date();
                filtered = filtered.filter(o => {
                    const od = parseDate(o.date);
                    if (dateFilter === 'today') return od.toDateString() === now.toDateString();
                    if (dateFilter === 'week') return (now - od) < 7 * 24 * 60 * 60 * 1000;
                    if (dateFilter === 'month') return now.getMonth() === od.getMonth() && now.getFullYear() === od.getFullYear();
                    return true;
                });
            }

            // Sort
            filtered.sort((a, b) => {
                const da = parseDate(a.date);
                const db = parseDate(b.date);
                return sortOrder === 'desc' ? db - da : da - db;
            });

            body.innerHTML = filtered.map(o => `
                <tr class="hover:bg-zinc-900/30 transition">
                    <td class="p-6">
                        <div class="font-mono text-[10px] text-zinc-500">${o.id}</div>
                        <div class="text-[10px] font-bold mt-1 text-zinc-400">${o.date} ${o.time || ''}</div>
                    </td>
                    <td class="p-6">
                        <div class="font-bold text-sm">${o.name}</div>
                        <div class="text-[10px] text-zinc-500 font-mono">${o.phone}</div>
                    </td>
                    <td class="p-6">
                        <span class="px-3 py-1 bg-zinc-900 rounded-full text-[10px] font-black gold-text border border-zinc-800">${o.type}</span>
                    </td>
                    <td class="p-6">
                        <div class="font-black text-sm">${Number(o.price).toLocaleString()} <span class="text-[10px] opacity-40 italic">сом</span></div>
                    </td>
                    <td class="p-6">
                        <select onchange="updateStatus('${o.id}', this.value)" class="bg-zinc-900/50 p-2 rounded-lg text-[9px] font-black uppercase border-none focus:ring-0 ${o.status === 'done' ? 'text-green-500' : (o.status === 'progress' ? 'text-blue-500' : 'text-red-500')}">
                            <option value="pending" ${o.status==='pending'?'selected':''}>Очередь</option>
                            <option value="progress" ${o.status==='progress'?'selected':''}>В работе</option>
                            <option value="done" ${o.status==='done'?'selected':''}>Готово</option>
                        </select>
                    </td>
                    <td class="p-6 text-right">
                        <button onclick="del('${o.id}')" class="w-8 h-8 rounded-full hover:bg-red-500/10 hover:text-red-500 transition text-zinc-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            if(filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-zinc-600 text-[10px] uppercase tracking-widest font-bold">Записей не найдено</td></tr>`;
            }
        }

        document.getElementById('orderForm').onsubmit = (e) => {
            e.preventDefault();
            const now = new Date();
            const entry = {
                id: 'TM-' + Math.floor(10000 + Math.random() * 90000),
                name: document.getElementById('form-name').value,
                phone: document.getElementById('form-phone').value,
                type: document.getElementById('form-type').value,
                price: document.getElementById('form-price').value || 0,
                status: 'pending',
                date: now.toLocaleDateString('ru-RU'),
                time: now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };
            db.unshift(entry);
            persist();
            e.target.reset();
            document.getElementById('form-phone').value = "+996 ";
            showSection('database');
            notify('ЗАКАЗ ЗАРЕГИСТРИРОВАН');
        };

        // --- UTILS ---

        function parseDate(str) {
            const parts = str.split('.');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        async function callGemini(prompt) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "Ошибка ИИ сервиса."; }
        }

        function setAILoader(id, state) {
            const btn = document.getElementById(id);
            if(state) {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner animate-spin mr-2"></i> ГЕНЕРАЦИЯ...`;
                btn.classList.add('opacity-50');
            } else {
                btn.disabled = false;
                btn.innerText = id === 'btn-video' ? 'Создать Видео-Промо' : (id === 'btn-poster' ? 'Генерировать Баннер' : 'Рассчитать стоимость');
                btn.classList.remove('opacity-50');
            }
        }

        function showStudioContent(title, html) {
            document.getElementById('studio-title').innerText = title;
            document.getElementById('studio-content').innerHTML = html;
            document.getElementById('ai-studio-output').classList.remove('hidden');
            document.getElementById('ai-studio-output').scrollIntoView({ behavior: 'smooth' });
        }

        function closeStudio() { document.getElementById('ai-studio-output').classList.add('hidden'); }

        function notify(t) {
            const n = document.getElementById('notify');
            document.getElementById('notify-text').innerText = t;
            n.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => n.classList.add('opacity-0', 'translate-y-20'), 3000);
        }

        function updateStatus(id, s) { db = db.map(o => o.id === id ? {...o, status: s} : o); persist(); notify('СТАТУС ИЗМЕНЕН'); }
        function del(id) { if(confirm('Удалить заказ из базы?')) { db = db.filter(o => o.id !== id); persist(); notify('УДАЛЕНО'); } }

        async function handleAISend() {
            const input = document.getElementById('ai-input');
            const msg = input.value;
            if(!msg) return;
            addChatMessage(msg, 'user');
            input.value = '';
            
            const prompt = `Ты AI-аналитик Talas_master. Данные: ${JSON.stringify(db)}. Помоги пользователю. Ответ должен быть коротким. Запрос: ${msg}`;
            const reply = await callGemini(prompt);
            addChatMessage(reply, 'ai');
        }

        function addChatMessage(t, type) {
            const c = document.getElementById('chat-messages');
            const d = document.createElement('div');
            d.className = type === 'ai' ? 'ai-message p-4' : 'user-message p-4 ml-auto max-w-[85%] font-bold';
            d.innerText = t;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        function searchOrders() {
            const query = document.getElementById('globalSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#db-table-body tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        async function speakSummary() {
            const total = document.getElementById('dash-revenue').innerText;
            const text = `Say clearly: Уважаемый мастер! Общая выручка за всё время составляет ${total}. У вас ${db.length} активных заказов в базе. Хорошего дня!`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: text }] }], 
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } } 
                    })
                });
                const result = await response.json();
                playAudio(result.candidates[0].content.parts[0].inlineData.data);
            } catch (e) { notify('Ошибка озвучки'); }
        }

        function playAudio(base64Data) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const binaryString = window.atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + bytes.length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, 24000, true);
            view.setUint32(28, 24000 * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, bytes.length, true);
            const blob = new Blob([new Uint8Array(buffer), bytes], { type: 'audio/wav' });
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `talas_db_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            notify('ЭКСПОРТ ВЫПОЛНЕН');
        }
    </script>
</body>
</html>
